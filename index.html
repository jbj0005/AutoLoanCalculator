<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auto Loan Calculator</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="apple-touch-icon" href="favicon.png" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Supabase: use UMD so window.supabase is defined -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <!-- Other libs (OK to defer) -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Your keys/config must load before app.js -->
  <script defer src="config.js"></script>

  <!-- App (defer so it runs after the above scripts are parsed) -->
  <script defer src="app.js"></script>
</head>
 <body>
    <header class="app-header">
      <h1>Brandon's Auto Loan Calculator</h1>
      <div class="header-pills">
        <div id="supabase-status" class="status warn">Supabase not configured</div>
        <div id="version" class="pill version">v0.2.2</div>
      </div>
    </header>

    <main class="container">
      <section class="panel" id="db-panel">
        <div class="panel-header">
          <h2>Vehicle Database</h2>
        </div>
        <div class="db-row vehicles-row">
          <div class="row-actions">
            <select id="vehicleSelect">
              <option value="">Select Vehicle</option>
            </select>
          </div>
        </div>
        <div class="db-actions">
          <button id="addVehicleBtn" class="btn">Add</button>
          <button id="updateVehicleBtn" class="btn">Update</button>
          <button id="deleteVehicle" class="btn" title="Delete selected vehicle">Delete</button>
        </div>
        
      </section>

      <!-- Current Vehicle Summary -->
      <section class="summary" id="vehicleSummary">
        <div class="item"><span class="label">Vehicle:</span> <span class="value" id="summaryVehicle">—</span></div>
        <div class="item"><span class="label">MSRP / Asking Price:</span> <span class="value" id="summaryMsrp">—</span></div>
      </section>

      <section class="panel" id="calc-panel">
        <div class="panel-header">
          <h2>Calculator</h2>
          <div id="calcMessages" class="messages"></div>
          <button id="clearCalc" class="btn small" title="Clear all inputs">Clear</button>
        </div>
        <form id="calcForm" action="#" class="stack" autocomplete="on">

          

          <div class="cell">
            <div class="cell-label">Final Sale Price</div>
            <div class="cell-value">
              <input id="finalPrice" type="text" inputmode="decimal" enterkeyhint="done" placeholder="$80,000.00" />
              <div id="savings" class="note"></div>
              <div class="hint">Supports formulas: e.g. <code>(MSRP - $7,500)</code></div>
            </div>
          </div>

          <div class="cell">
            <div class="cell-label">Trade-in</div>
            <div class="cell-value">
              <div class="trade-grid">
                <div class="t-label">Trade-in Value</div>
                <div class="op">−</div>
                <div class="t-label">Trade-in Payoff</div>
                <div class="op">=</div>
                <div class="t-label">Trade Equity</div>

                <input id="tradeValue" type="text" inputmode="decimal" enterkeyhint="done" placeholder="$18,000.00" />
                <div class="op">−</div>
                <input id="loanPayoff" type="text" inputmode="decimal" enterkeyhint="done" placeholder="$14,000.00" />
                <div class="op">=</div>
                <output id="tradeEquity">- -</output>
              </div>
            </div>
          </div>

          <div class="cell">
            <div class="cell-label">Dealer Fees</div>
            <div class="cell-value">
              <div id="dealerFeesList" class="fees-list"></div>
              <div class="fees-actions">
                <button id="addFee" type="button" class="btn small">Add Fee</button>
                <span class="spacer"></span>
                <span>Total: <strong id="dealerFeesTotal">$0.00</strong></span>
              </div>
            </div>
          </div>

          <div class="cell">
            <div class="cell-label">Gov't Fees</div>
            <div class="cell-value">
              <div id="govFeesList" class="fees-list"></div>
              <div class="fees-actions">
                <select id="govFeePreset" class="preset-select small">
                  <option value="">Presets…</option>
                  <optgroup label="Registration &amp; Plate Fees">
                    <option data-name="Car &lt; 2,500 lbs" value="14.50">Car &lt; 2,500 lbs — $14.50</option>
                    <option data-name="2,500 &gt; Car &lt; 3,499 lbs" value="22.50">2,500 &gt; Car &lt; 3,499 lbs — $22.50</option>
                    <option data-name="Car &gt; 3,500 lbs" value="32.50">Car &gt; 3,500 lbs — $32.50</option>
                    <option data-name="Truck &lt; 5,000 lbs" value="32.50">Truck &lt; 5,000 lbs — $32.50</option>
                    <option data-name="5,001 &gt; Truck &lt; 7,999 lbs" value="60.75">5,001 &gt; Truck &lt; 7,999 lbs — $60.75</option>
                    <option data-name="Truck &gt; 8,000 lbs" value="86.00">Truck &gt; 8,000 lbs — $86.00</option>
                  </optgroup>
                  <optgroup label="Registration">
                    <option data-name="Exempt (Weight &gt; 5k lbs)" value="0">Exempt (Weight &gt; 5k lbs) — $0.00</option>
                    <option data-name="Initial Registration" value="225.00">Initial Registration — $225.00</option>
                  </optgroup>
                  <optgroup label="Tag Fees">
                    <option data-name="Tag Transfer" value="10.00">Tag Transfer — $10.00</option>
                    <option data-name="1-Yr Tag" value="28.00">1-Yr Tag — $28.00</option>
                    <option data-name="2-Yr Tag" value="56.00">2-Yr Tag — $56.00</option>
                  </optgroup>
                  <optgroup label="Title Fees">
                    <option data-name="Electronic Title" value="85.75">Electronic Title — $85.75</option>
                    <option data-name="Paper Title" value="77.75">Paper Title — $77.75</option>
                  </optgroup>
                </select>
                <button id="addGovFee" type="button" class="btn small">Add Fee</button>
                <span class="spacer"></span>
                <span>Total: <strong id="govFeesTotal">$0.00</strong></span>
              </div>
            </div>
          </div>

          <div class="cell">
            <div class="cell-label with-action">Taxes (FL)
              <button id="openTaxFormula" class="link-btn" type="button">Tax Calculation Formula</button>
            </div>
            <div class="cell-value">
              <output id="taxes">- -</output>
              <div class="note" id="taxesNote">6% state + county rate on first $5k</div>
              <div class="note" id="taxesRatesNote">County Tax Rate = - - (Default)</div>
              <div class="note"><span id="taxesBreakdown">State Tax — | County Tax —</span></div>
              <div class="note" id="tradeSavingsWith">Tax Savings w/ Trade-in: $0.00</div>
            </div>
          </div>

          <div class="cell">
            <div class="cell-label">Total Taxes &amp; Fees</div>
            <div class="cell-value">
              <output id="totalTF">- -</output>
            </div>
          </div>

          <div class="cell">
            <div class="cell-label">Cash Down</div>
            <div class="cell-value">
              <input id="cashDown" type="text" inputmode="decimal" enterkeyhint="done" placeholder="$5,000.00" />
              <div class="note downpayment-note" aria-live="polite">Only reduces Amount Financed.</div>
              <div class="note downpayment-goal" aria-live="polite">
                <div class="goal-row">
                  <span>Goal Payment:</span>
                  <input id="goalMonthly" class="goal-input" type="text" inputmode="decimal" enterkeyhint="done" placeholder="$1,000" size="8" />
                </div>
                <div id="goalDownResult" class="goal-down-out"></div>
              </div>
            </div>
          </div>

          <div class="cell">
            <div class="cell-label">Amount Financed</div>
            <div class="cell-value">
              <div class="amount-row">
                <label class="checkbox"><input id="financeTF" type="checkbox" /> Finance Taxes &amp; Fees</label>
                <div class="big" id="amountFinanced">- -</div>
              </div>
              <div class="note faint"><span id="pmtSavings">Tax &amp; Fees Savings = —</span></div>
            </div>
          </div>

          <div class="cell">
            <div class="cell-label">APR / Term</div>
            <div class="cell-value">
              <div class="inline-2">
                <input id="apr" type="text" inputmode="decimal" enterkeyhint="done" placeholder="APR e.g., 7.49" value="6.50" />
                <div class="input-with-suffix">
                  <input id="term" list="termOptions" inputmode="numeric" enterkeyhint="done" pattern="[0-9]*" placeholder="60" value="72" />
                  <span class="suffix">Months</span>
                </div>
                <datalist id="termOptions">
                  <option value="36"></option>
                  <option value="42"></option>
                  <option value="48"></option>
                  <option value="60"></option>
                  <option value="72"></option>
                  <option value="84"></option>
                </datalist>
              </div>
              <div class="note">Monthly Rate = <span id="monthlyApr">—</span></div>
            </div>
          </div>

          <div class="cell">
            <div class="cell-label">Monthly Payment</div>
            <div class="cell-value">
              <div class="big" id="monthlyPayment">- -</div>
              <div class="note faint">0% APR reference: <span id="payment0">- -</span></div>
              <div class="note">Delta vs 0%: <span id="paymentDelta">- -</span></div>
            </div>
          </div>
        </form>
      </section>

      

      
    </main>

    <!-- Vehicle Modal -->
    <div id="vehicleModal" class="modal" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="vehicleModalTitle">
        <div class="modal-header">
          <h3 id="vehicleModalTitle">Vehicle</h3>
          <button id="modalClose" class="btn small" aria-label="Close">Close</button>
        </div>
        <div class="modal-body">
            <div class="db-row">
              <label for="dbVehicleName">Name</label>
              <input id="dbVehicleName" type="text" placeholder="e.g. 2025 Ram 1500 Limited" />
            </div>
            <div class="db-row">
              <label for="dbMsrp">MSRP / Asking Price</label>
              <input id="dbMsrp" type="text" inputmode="decimal" placeholder="$83,000.00" />
            </div>
          
        </div>
        <div class="modal-footer">
          <button id="saveVehicle" class="btn primary">Save</button>
          <button id="modalCancel" class="btn">Cancel</button>
        </div>
      </div>
    </div>

    

    <!-- County Rates Modal -->
    <div id="ratesModal" class="modal" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="ratesModalTitle">
        <div class="modal-header">
          <h3 id="ratesModalTitle">Import County Rates</h3>
          <button id="ratesClose" class="btn small" aria-label="Close">Close</button>
        </div>
        <div class="modal-body">
          <div class="db-row">
            <label for="stateRateInput">State Rate</label>
            <input id="stateRateInput" type="text" inputmode="decimal" placeholder="0.06" />
          </div>
          <div class="db-row">
            <label for="countyCapInput">County Cap ($)</label>
            <input id="countyCapInput" type="text" inputmode="numeric" placeholder="5000" />
          </div>
          <div class="db-row">
            <label for="ratesFile">Upload File</label>
            <input id="ratesFile" type="file" accept=".xlsx,.xls,.csv,.tsv,.txt" />
          </div>
          <div class="hint">Paste either JSON or copy-paste from Excel/CSV/TSV (must include County and Rate columns). Headers like "County", "Rate", or "Surtax" are detected automatically.</div>
          <textarea id="ratesInput" rows="12" style="width:100%; background:#0f1319; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:10px" placeholder='County	Rate%\nBrevard	1.5%\nOrange	0.5%'></textarea>
          <div class="rates-preview">
            <div class="hint">Preview (first 15 rows)</div>
            <div id="ratesPreview"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="loadRatesSample" class="btn">Load Sample</button>
          <button id="saveRates" class="btn primary">Save Rates</button>
          <button id="ratesCancel" class="btn">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Tax Formula Modal -->
    <div id="formulaModal" class="modal" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="formulaModalTitle">
        <div class="modal-header">
          <h3 id="formulaModalTitle">Tax Calculation Formula</h3>
          <button id="formulaClose" class="btn small" aria-label="Close">Close</button>
        </div>
        <div class="modal-body">
          <div class="db-row" style="display:block">
            <div class="note wrap-note" id="formulaRatesLine">—</div>
            <div class="note wrap-note">State tax = stateRate × taxableBase</div>
            <div class="note wrap-note">County surtax = countyRate × min(taxableBase, $5,000)</div>
            <div class="note wrap-note">Taxable base = max(Final Sale Price − Trade-in, 0) + Dealer Fees</div>
            <div class="hint wrap-note">Government/DMV fees are not taxable. County surtax applies only to the first $5,000.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="formulaCancel" class="btn">Close</button>
        </div>
      </div>
    </div>
  </body>
  </html>
